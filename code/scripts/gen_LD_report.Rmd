---
title: "Data Report"
author:
    - "Nicholas Knoblauch"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
   rmd: "gen_data_report.Rmd"
output:
  html_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
---

## RSSp results

```{r load_data,echo=F,message=F}

setwd("~/Dropbox/PolygenicRSS/code/snakemake_files/")
library(tidyverse)
evdf <- dir("~/Desktop/scratch/polyg_scratch/EVD_H5_bigsub",full.names=T)
tR <- read_2d_mat_h5(evdf[1],"LD","R")
tQ <- read_2d_mat_h5(evdf[1],"EVD","Q")
tD <- read_dvec(evdf[1],"EVD","D")
tQsq <- tQ%*%tQ
rss_rdsf <- snakemake@input[["rdsf"]]
uh_rdsf <- snakemake@input[["uhrdsf"]]

rss_dat <- readRDS(rss_rdsf)


tparam_df <- rss_dat$tparam_df %>% group_by(tbias,tsigu) %>% do(mutate(.,replicate=as.integer(.$fgeneid)%%n())) %>% ungroup()%>% arrange(replicate) %>% mutate(rel_bias=round(tbias/tpve,2))
quh_mat <- rss_dat$quh_mat
uh_mat <- readRDS(uh_rdsf)[["uh_mat"]]
colnames(uh_mat) <- paste0("uh_",tparam_df$fgeneid)
D <- rss_dat$D

traitn <- snakemake@params[["traitn"]]
methn <- snakemake@params[["methn"]]
p <- unique(tparam_df$p)
n <- unique(tparam_df$n)

```

The name for this trait is `r traitn`.  It was generated by `r methn`.  There were `r p` SNPs  and `r n` individuals.


```{r}
library(ggjoy)
colnames(quh_mat) <- paste0("quh_",tparam_df$fgeneid)
sim_df <- as_data_frame(cbind(quh_mat,uh_mat)) %>% 
  mutate(snp_id=1:n()) %>% 
  gather("fgeneid","traitv",-snp_id) %>% 
  separate(fgeneid,c("type","fgeneid"))%>% 
  spread(type,traitv) %>% inner_join(tparam_df)

sim_df <- data_frame(D=D) %>% mutate(snp_id=1:n()) %>% inner_join(sim_df)




filter(sim_df,tbias==0,quh!=0) %>% mutate(tsigu=factor(round(tsigu,2)),quh_sq=quh^2)%>% ggplot(aes(y=tsigu,x=quh_sq))+
geom_joy()+scale_x_log10()



```

```{r}
distinct(sim_df,D) %>% ggplot(aes(x=D))+geom_histogram()
```


```{r}
filter(sim_df,tbias==0) %>% ggplot(aes(y=factor(round(tsigu,2)),x=uh^2))+
geom_joy()+scale_x_log10()
```

```{r}
filter(sim_df,tbias==0) %>%  ggplot(aes(x=uh^2,y=quh^2))+stat_bin_hex()+facet_wrap(~round(tsigu,2),scales = "free_y")+geom_smooth(method="lm")
```


```{r}
```

```{r}
filter(quh_df,tbias==0) %>%  ggplot(aes(sample=quh))+stat_qq()+facet_wrap(~round(tsigu,2))+ggtitle("quh qq_plot")
```

```{r}
filter(sim_df,tbias==0) %>% mutate(s_sigu=round(tsigu,2))%>% ggplot(aes(sample=uh))+stat_qq()+facet_wrap(~s_sigu)+ggtitle("uh qq_plot")
```


```{r}
filter(sim_df,tbias==0) %>% mutate(s_sigu=round(tsigu,2),rel_h=quh^2/uh^2)%>% ggplot(aes(x=rel_h,..density..))+geom_histogram(bins=1000)+facet_wrap(~s_sigu)+ggtitle("quh/uh")+scale_x_log10()
```


